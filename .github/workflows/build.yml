name: Build (all platforms)

on:
  push:
    tags: ["v*"]

permissions:
  contents: read

jobs:
  build:
    name: ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
          - os: ubuntu-latest
            target: aarch64-linux-android
          - os: windows-latest
            target: x86_64-pc-windows-msvc
          - os: windows-latest
            target: aarch64-pc-windows-msvc
          - os: macos-latest
            target: x86_64-apple-darwin
          - os: macos-latest
            target: aarch64-apple-darwin

    env:
      CARGO_TERM_COLOR: always
      TARGET: ${{ matrix.target }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: "1.93.0"
          targets: ${{ matrix.target }}

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: build-${{ matrix.os }}-${{ matrix.target }}

      - name: Install aarch64 cross toolchain (Linux)
        if: matrix.os == 'ubuntu-latest' && matrix.target == 'aarch64-unknown-linux-gnu'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu

      - name: Setup Android SDK/NDK
        if: matrix.os == 'ubuntu-latest' && matrix.target == 'aarch64-linux-android'
        uses: android-actions/setup-android@v3
        with:
          packages: "platforms;android-34 build-tools;34.0.0 ndk;26.1.10909125"

      - name: Install cargo-ndk
        if: matrix.os == 'ubuntu-latest' && matrix.target == 'aarch64-linux-android'
        run: cargo install cargo-ndk --locked

      - name: Build
        shell: bash
        run: |
          if [[ "$TARGET" == "aarch64-linux-android" ]]; then
            export ANDROID_NDK_ROOT="$ANDROID_SDK_ROOT/ndk/26.1.10909125"
            cargo ndk -t arm64-v8a build --release --locked
          else
            if [[ "$TARGET" == "aarch64-unknown-linux-gnu" ]]; then
              export CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc
            fi
            cargo build --release --locked --target "$TARGET"
          fi

      - name: Prepare artifact
        shell: bash
        run: |
          python - <<'PY'
          import json
          import os
          import pathlib
          import shutil
          import subprocess
          import sys

          target = os.environ["TARGET"]
          meta = json.loads(
              subprocess.check_output(["cargo", "metadata", "--no-deps", "--format-version", "1"])
          )

          bin_targets = []
          for pkg in meta.get("packages", []):
              for t in pkg.get("targets", []):
                  if "bin" in (t.get("kind") or []):
                      bin_targets.append(t.get("name"))

          if not bin_targets:
              print("No binary targets found in cargo metadata.", file=sys.stderr)
              sys.exit(1)

          bin_name = bin_targets[0]
          ext = ".exe" if os.name == "nt" or "windows" in target else ""
          src = pathlib.Path("target") / target / "release" / f"{bin_name}{ext}"
          if not src.exists():
              print(f"Built binary not found: {src}", file=sys.stderr)
              sys.exit(1)

          out_dir = pathlib.Path("dist")
          out_dir.mkdir(parents=True, exist_ok=True)

          archive_basename = out_dir / f"{bin_name}-{target}"
          if "windows" in target:
              archive_path = shutil.make_archive(str(archive_basename), "zip", root_dir=src.parent, base_dir=src.name)
          else:
              archive_path = shutil.make_archive(str(archive_basename), "gztar", root_dir=src.parent, base_dir=src.name)

          print(f"Prepared archive: {archive_path}")
          PY

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: asterclaw-${{ matrix.target }}
          path: dist/*
          if-no-files-found: error

  release:
    name: Draft release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write

    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Create draft GitHub release
        uses: softprops/action-gh-release@v1
        with:
          draft: true
          files: dist/**/*.{zip,tar.gz}

